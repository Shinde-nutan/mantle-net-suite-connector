<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-3.xsd">

    <service verb="generate" noun="TransferOrderFulfilledItemsFeed" authenticate="anonymous-all" transaction-timeout="7200">
        <description>
            Service to generate Transfer Order Fulfilled Items Feed.
        </description>
        <in-parameters>
            <parameter name="systemMessageRemoteId" required="true">
                <description>The System Message Remote ID for generating the Transfer Order Fulfilled Items Feed.</description>
            </parameter>
            <parameter name="systemMessageTypeId" required="true">
                <description>The System Message Type ID for generating the Transfer Order Fulfilled Items Feed.</description>
            </parameter>
            <parameter name="orderId">
                <description>Parameter to fetch the Transfer Order Fulfilled Items details for a specific orderId.</description>
            </parameter>
            <parameter name="orderItemSeqId">
                <description>Parameter to fetch Transfer Order Fulfilled item details for a specific orderItemSeqId.</description>
            </parameter>
            <parameter name="orderStatusId">
                <description>
                    Parameter to fetch Transfer Order Fulfilled item details for a specific Order Status ID.
                </description>
            </parameter>
            <parameter name="productStoreIds" type="List">
                <description>
                    List of product Store Ids for generating Transfer Order Fulfilled Items feed.
                    For passing the Product Store Ids as list.
                </description>
            </parameter>
            <parameter name="parentFacilityTypeIds" type="List">
                <description>
                    List of parent Facility Type Ids for generating Transfer Order Fulfilled Items Feed.
                    For passing the parent Facility Type Ids as list, add values like - PHYSICAL_STORE,DISTRIBUTION_CENTER,VIRTUAL_FACILITY and for single value use - PHYSICAL_STORE.
                </description>
            </parameter>
        </in-parameters>
        <actions>
            <set field="nowDate" from="ec.user.nowTimestamp"/>
            <log message="Generating Transfer Order Fulfilled Items Feed file of HotWax for Order ${orderId}, at time ${nowDate}"/>

            <script>
                import com.fasterxml.jackson.core.JsonGenerator
                import com.fasterxml.jackson.core.JsonFactory
                import com.fasterxml.jackson.databind.ObjectMapper
                import java.nio.charset.StandardCharsets
                import org.moqui.entity.EntityCondition

                // Dynamic view to retrieve eligible transfer orders for the transfer order fulfilled items feed.

                def fulfilledTransferOrder_find = ec.entity.find("org.apache.ofbiz.order.order.OrderHeader")
                dynamicView = fulfilledTransferOrder_find.makeEntityDynamicView()
                dynamicView.setEntityName("FulfilledTransferOrder")

                dynamicView.addMemberEntity("OH", "org.apache.ofbiz.order.order.OrderHeader", null, null, null)
                dynamicView.addMemberEntity("OI", "org.apache.ofbiz.order.order.OrderItem","OH", true,["orderId":"orderId"])
                dynamicView.addMemberEntity("OSH", "org.apache.ofbiz.order.order.OrderShipment","OI", true,["shipGroupSeqId":"shipGroupSeqId","orderId":"orderId", "orderItemSeqId":"orderItemSeqId"])
                dynamicView.addMemberEntity("SH", "org.apache.ofbiz.shipment.shipment.Shipment", "OSH", true, ["shipmentId":"shipmentId"])
                dynamicView.addMemberEntity("SRS", "org.apache.ofbiz.shipment.shipment.ShipmentRouteSegment", "SH", true, ["shipmentId":"shipmentId"])
                dynamicView.addMemberEntity("OFH", "co.hotwax.integration.order.OrderFulfillmentHistory", "OSH", true, ["shipmentId":"shipmentId","orderId":"orderId", "orderItemSeqId":"orderItemSeqId"])
                dynamicView.addMemberEntity("OISG", "org.apache.ofbiz.order.order.OrderItemShipGroup",  "OI", true, ["shipGroupSeqId":"shipGroupSeqId","orderId":"orderId"])
                dynamicView.addMemberEntity("F", "org.apache.ofbiz.product.facility.Facility", "OISG", true, ["facilityId":"facilityId"])
                dynamicView.addMemberEntity("FT", "org.apache.ofbiz.product.facility.FacilityType", "F",  true, ["facilityTypeId":"facilityTypeId"])

                dynamicView.addAlias("OH", "orderId")
                dynamicView.addAlias("OH", "orderName")
                dynamicView.addAlias("OH", "orderTypeId")
                dynamicView.addAlias("OH", "orderStatusId", "statusId", null)
                dynamicView.addAlias("OH", "orderExternalId", "externalId", null)
                dynamicView.addAlias("OSH", "shipmentId")
                dynamicView.addAlias("SRS", "trackingIdNumber")
                dynamicView.addAlias("SH", "shipmentStatusId", "statusId", null)
                dynamicView.addAlias("FT", "parentFacilityTypeId", "parentTypeId", null)
                dynamicView.addAlias("OFH", "fulfillmentLogId")

                fulfilledTransferOrder_find.condition("shipmentStatusId", "SHIPMENT_SHIPPED")
                fulfilledTransferOrder_find.condition("fulfillmentLogId", EntityCondition.IS_NULL, null)
                fulfilledTransferOrder_find.condition("orderTypeId", "TRANSFER_ORDER")

                if(orderId) fulfilledTransferOrder_find.condition("orderId", orderId)
                if(orderItemSeqId) fulfilledTransferOrder_find.condition("orderItemSeqId", orderItemSeqId)
                if(orderStatusId) fulfilledTransferOrder_find.condition("orderStatusId", orderStatusId)
                if(productStoreIds) fulfilledTransferOrder_find.condition("productStoreId",EntityCondition.ComparisonOperator.IN, productStoreIds)
                if(parentFacilityTypeIds) fulfilledTransferOrder_find.condition("parentFacilityTypeId",EntityCondition.ComparisonOperator.IN, parentFacilityTypeIds)
                fulfilledTransferOrder_find.selectField("shipmentId,orderExternalId,orderName,trackingIdNumber")
                fulfilledTransferOrder_find.distinct(true)


                // Using try-with-resources to automatically close the EntityListIterator 'fulfilledTransferOrdersItr'
                try (fulfilledTransferOrdersItr = fulfilledTransferOrder_find.iterator()) {
            </script>

            <!-- If no orders in fulfilledTransferOrdersItr, then don't generate the file -->
            <if condition="!fulfilledTransferOrdersItr.hasNext()">
                <return message="No eligible orders for Fulfilled Transfer Order Items Feed at ${nowDate}, not generating the HotWax Feed file."/>
            </if>

            <!-- Fetch the receivePath from SystemMessageType to prepare the path for creating the file in the receiving system. Ex: Moqui's datamanager directory in runtime for creating feeds.-->
            <entity-find-one entity-name="moqui.service.message.SystemMessageType" value-field="systemMessageType"/>
            <if condition="systemMessageType == null"><return error="true" message="Could not find SystemMessageType with ID ${systemMessageTypeId}"/></if>

            <!-- Prepare Transfer Order Fulfilled Items JSON File Path -->
            <!-- Using receivePath from SystemMessageType to prepare the jsonFilePathRef.-->
            <set field="jsonFilePathRef" from="ec.resource.expand(systemMessageType.receivePath, null,
                [contentRoot: ec.user.getPreference('mantle.content.root') ?: 'dbresource://datamanager', date:ec.l10n.format(nowDate, 'yyyy-MM-dd'),
                dateTime:ec.l10n.format(nowDate, 'yyyy-MM-dd-HH-mm-ss-SSS')], false)"/>

            <set field="jsonFilePath" from="ec.resource.getLocationReference(jsonFilePathRef).getUri().getPath()"/>

            <!-- Prepare the Transfer Order Fulfilled Items Feed file  -->
            <script>

                try {
                    //json file
                    File fulfilledTransferOrderItemsFeedFile = new File(jsonFilePath)
                    if (!fulfilledTransferOrderItemsFeedFile.parentFile.exists()) fulfilledTransferOrderItemsFeedFile.parentFile.mkdirs()
                    JsonFactory jfactory = new JsonFactory()

                    /* Declaring the PrintWriter and JsonGenerator resources in the try statement,
                        so that they are automatically closed regardless of whether the try statement completes normally or abruptly. */
                    try (PrintWriter pw = new PrintWriter(StandardCharsets.UTF_8, fulfilledTransferOrderItemsFeedFile);
                         JsonGenerator jGenerator = jfactory.createGenerator(pw)) {
                        jGenerator.writeStartArray()
            </script>

            <iterate list="fulfilledTransferOrdersItr" entry="fulfilledTransferOrder">

                <set field="fulfillmentDetails" from="[order_id:fulfilledTransferOrder.orderExternalId,order_name:fulfilledTransferOrder.orderName,tracking_number:fulfilledTransferOrder.trackingIdNumber,shipment_id:fulfilledTransferOrder.shipmentId]" type="NewMap"/>

                <set field="items" from="[]"/>

                <script>

                    // dynamicView to fetch item details for eligible shipmentId
                    def entityFind = ec.entity.find("org.apache.ofbiz.order.order.OrderItem")
                    dynamicView = entityFind.makeEntityDynamicView()
                    dynamicView.setEntityName("transferOrderItems")

                    dynamicView.addMemberEntity("OI", "org.apache.ofbiz.order.order.OrderItem", null, null, null)
                    dynamicView.addMemberEntity("OSH", "org.apache.ofbiz.order.order.OrderShipment","OI", true,["shipGroupSeqId":"shipGroupSeqId","orderId":"orderId", "orderItemSeqId":"orderItemSeqId"])

                    dynamicView.addAlias("OI", "orderId")
                    dynamicView.addAlias("OI", "orderItemSeqId")
                    dynamicView.addAlias("OI", "orderItemExternalId", "externalId", null)
                    dynamicView.addAlias("OSH", "shipmentId")
                    dynamicView.addAlias("OSH", "shippedQuantity", "quantity", null)

                    entityFind.condition("shipmentId", fulfilledTransferOrder.shipmentId)
                    try (fulfilledItems = entityFind.iterator()) {
                </script>

                <iterate list="fulfilledItems" entry="fulfilledItem">

                    <script>
                        itemMap = [lineId:fulfilledItem.orderItemExternalId, quantity:fulfilledItem.shippedQuantity, tags:"hotwax-fulfilled"]
                        items.add(itemMap)
                    </script>

                    <service-call name="create#co.hotwax.integration.order.OrderFulfillmentHistory" in-map="[orderId:fulfilledItem.orderId,
                        orderItemSeqId:fulfilledItem.orderItemSeqId, shipmentId:fulfilledTransferOrder.shipmentId,
                        comments:'Order Item sent as part of Transfer Fulfilled Order Items Feed', createdDate:nowDate,
                        externalFulfillmentId:'_NA_']"/>

                </iterate>
                <script>
                    }
                </script>

                <set field="fulfillmentDetails.items" from="items"/>

                <script>
                    new ObjectMapper()
                    .setDateFormat(new java.text.SimpleDateFormat(System.getProperty('default_date_time_format')))
                    .writerWithDefaultPrettyPrinter().writeValue(jGenerator, fulfillmentDetails)
                </script>
            </iterate>
            <script>
                        jGenerator.writeEndArray()
                        }
                    }
                catch (IOException e) {
                    logger.info("Error preparing transfer order fulfilled items Feed file", e)
                }
            }
            </script>

            <!-- Save the Json Feed File path in System Message messageText -->
            <service-call name="org.moqui.impl.SystemMessageServices.queue#SystemMessage"
                in-map="[systemMessageTypeId:systemMessageTypeId, systemMessageRemoteId:systemMessageRemoteId,
                messageText:jsonFilePathRef, productStoreId:productStoreId]" out-map="fulfillmentFeedSysMsgOut"/>

            <return message="Completed Transfer Order Fulfilled Items Feed file at time ${ec.user.nowTimestamp} with type ${systemMessageTypeId} and
                remote ${systemMessageRemoteId} saved response in messages ${fulfillmentFeedSysMsgOut?.systemMessageId}"/>
        </actions>
    </service>
</services>