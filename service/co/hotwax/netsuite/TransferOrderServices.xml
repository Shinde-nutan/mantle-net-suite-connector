<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-3.xsd">

    <service verb="map" noun="StoreTransferOrderFulfillment" transaction-timeout="1800">
        <in-parameters>
            <parameter name="payload" type="Map" required="true">
                <description>The Transfer Order Fulfillment map from NetSuite to be mapped as per Shipment in OMS.</description>
                <parameter name="shipmentId"/>
                <parameter name="externalId"/>
                <parameter name="items" type="List">
                    <parameter name="itemMap" type="Map">
                        <parameter name="externalId"/>
                        <parameter name="productIdType"/>
                        <parameter name="productIdValue"/>
                    </parameter>
                </parameter>
            </parameter>
        </in-parameters>
        <out-parameters>
            <parameter name="payload" type="Map">
                <description>The Shipment map with mapped fields for OMS.</description>
                <parameter name="shipmentId"/>
                <parameter name="externalId"/>
                <parameter name="ShipmentItem" type="List">
                    <parameter name="itemMap" type="Map">
                        <parameter name="shipmentItemSeqId"/>
                        <parameter name="externalId"/>
                        <parameter name="productId"/>
                    </parameter>
                </parameter>
            </parameter>
        </out-parameters>
        <actions>
            <iterate list="payload.items" entry="item">
                <!-- Get HC Product ID -->
                <entity-find entity-name="org.apache.ofbiz.product.product.GoodIdentification" list="goodIdentifications" limit="1">
                    <econdition field-name="goodIdentificationTypeId" from="item.remove('productIdType')"/>
                    <econdition field-name="idValue" from="item.remove('productIdValue')"/>
                    <date-filter/>
                    <order-by field-name="-fromDate"/>
                </entity-find>
                <set field="item.productId" from="goodIdentifications?.first?.productId"/>

                <!-- Get shipment Item Seq ID  -->
                <entity-find entity-name="org.apache.ofbiz.shipment.shipment.ShipmentItem" list="shipmentItemList">
                    <econdition field-name="shipmentId" from="payload.shipmentId"/>
                    <econdition field-name="productId" from="item.productId"/>
                </entity-find>
                <set field="item.shipmentItemSeqId" from="shipmentItemList?.first?.shipmentItemSeqId"/>
            </iterate>
        </actions>
    </service>
</services>